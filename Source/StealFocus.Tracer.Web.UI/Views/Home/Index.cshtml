@{
    ViewBag.Title = "StealFocus - Tracer";
}
<script type="text/javascript" >
    var traceHub;

    $(function () {
        traceHub = $.connection.traceHub;
        traceHub.addTraceEvent = onAddTraceEvent;
        $("#sendTraceEventButton").click(onSendTraceEvent);
        $.connection.hub.start();
    });
    
    function getTraceEventHasGotAnExistingThread(correlationId) {
        var existingThreadDiv = $('#' + correlationId);
        if (existingThreadDiv.length > 0) {
            return true;
        }
        return false;
    }

    function getTraceEventHasGotAnExistingBatch(batchId) {
        var existingBatchDiv = $('#' + batchId);
        if (existingBatchDiv.length > 0) {
            return true;
        }
        return false;
    }

    function createNewThread(correlationId) {
        var threadMarkup = '<div id="' + correlationId + '" />';
        $('#traceEvents').append(threadMarkup);
    }

    function createNewBatch(correlationId, batchId) {
        var batchMarkup = '<div id="' + batchId + '" />';
        $('#' + correlationId).append(batchMarkup);
    }

    function getMarkupForTraceEvent(traceEvent) {
        return '<div id="' + traceEvent.Id + '">' + traceEvent.Source + ' - ' + traceEvent.Message + '</div>';
    }

    function onAddTraceEvent(traceEvent) {
        var traceEventHasGotAnExistingThread = getTraceEventHasGotAnExistingThread(traceEvent.CorrelationId);
        if (!traceEventHasGotAnExistingThread) {
            createNewThread(traceEvent.CorrelationId);
        }
        var traceEventHasGotAnExistingBatch = getTraceEventHasGotAnExistingBatch(traceEvent.BatchId);
        if (!traceEventHasGotAnExistingBatch) {
            createNewBatch(traceEvent.CorrelationId, traceEvent.BatchId);
        }
        var markupForTraceEvent = getMarkupForTraceEvent(traceEvent);
        $('#' + traceEvent.BatchId).append(markupForTraceEvent);
    }
</script>
@if (HttpContext.Current.Request.IsLocal)
{
    <script type="text/javascript" >
        function getTraceEvent() {
            var id = $('#id').val();
            var correlationId = $('#correlationId').val();
            var batchId = $('#batchId').val();
            var source = $('#source').val();
            var message = $('#message').val();
            return jQuery.parseJSON('{"Id":"' + id + '", "CorrelationId":"' + correlationId + '", "BatchId":"' + batchId + '", "Source":"' + source + '", "Message":"' + message + '"}');
        }

        function onSendTraceEvent() {
            var traceEvent = getTraceEvent();
            traceHub.send(traceEvent);
        }
    </script>
}
<h2>@ViewBag.Title</h2>
@if (HttpContext.Current.Request.IsLocal)
{
<form id="form1" runat="server">
    <div>
        ID: <input type="text" id="id" value="78fc923b-57b8-48af-938c-393b2dd54d9a" /><br />
        Correlation ID: <input type="text" id="correlationId" value="18fc923b-57b8-48af-938c-393b2dd54d9a" /><br />
        Batch ID: <input type="text" id="batchId" value="99fc923b-57b8-48af-938c-393b2dd54d2a" /><br />
        Source: <input type="text" id="source" /><br />
        Message: <input type="text" id="message" /><br />
        <input type="button" id="sendTraceEventButton" value="Test" />
    </div>
</form>
<br />
}
<div id="traceEvents">
</div>